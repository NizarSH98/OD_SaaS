{% extends "base.html" %}

{% block title %}Export Dataset - {{ metadata.video_name }}{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h2 mb-0">
                <i class="fas fa-download me-2 text-success"></i>
                Export Dataset
            </h1>
            <a href="{{ url_for('main.annotate', project_id=project_id) }}" class="btn btn-outline-primary">
                <i class="fas fa-arrow-left me-1"></i>
                Back to Annotation
            </a>
        </div>

        <!-- Project Summary -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    Project Summary
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <strong>Video Name:</strong><br>
                            <span class="text-muted">{{ metadata.video_name }}</span>
                        </div>
                        <div class="mb-3">
                            <strong>Total Frames:</strong><br>
                            <span class="text-muted">{{ metadata.extracted_count }}</span>
                        </div>
                        <div class="mb-3">
                            <strong>Frame Interval:</strong><br>
                            <span class="text-muted">{{ metadata.interval }}s</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <strong>Video Duration:</strong><br>
                            <span class="text-muted">{{ "%.1f"|format(metadata.duration) }}s</span>
                        </div>
                        <div class="mb-3">
                            <strong>Annotated Frames:</strong><br>
                            <span class="text-muted">{{ annotated_frames }}</span>
                        </div>
                        <div class="mb-3">
                            <strong>Created:</strong><br>
                            <span class="text-muted" id="createdDate">{{ metadata.created_at }}</span>
                        </div>
                    </div>
                </div>
                
                <!-- Progress Bar -->
                <div class="mt-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span><strong>Annotation Progress:</strong></span>
                        <span id="progressPercent">0%</span>
                    </div>
                    <div class="progress">
                        <div class="progress-bar" role="progressbar" style="width: 0%" id="progressBar">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-bar me-2"></i>
                    Dataset Statistics
                </h5>
            </div>
            <div class="card-body">
                <div class="row text-center" id="statsContainer">
                    <div class="col-md-3 col-6 mb-3">
                        <div class="border rounded p-3">
                            <i class="fas fa-images text-primary mb-2" style="font-size: 2rem;"></i>
                            <h4 class="mb-1" id="totalFrames">{{ metadata.extracted_count }}</h4>
                            <small class="text-muted">Total Frames</small>
                        </div>
                    </div>
                    <div class="col-md-3 col-6 mb-3">
                        <div class="border rounded p-3">
                            <i class="fas fa-tags text-success mb-2" style="font-size: 2rem;"></i>
                            <h4 class="mb-1" id="totalAnnotations">0</h4>
                            <small class="text-muted">Total Annotations</small>
                        </div>
                    </div>
                    <div class="col-md-3 col-6 mb-3">
                        <div class="border rounded p-3">
                            <i class="fas fa-check-circle text-warning mb-2" style="font-size: 2rem;"></i>
                            <h4 class="mb-1" id="annotatedFrames">{{ annotated_frames }}</h4>
                            <small class="text-muted">Annotated Frames</small>
                        </div>
                    </div>
                    <div class="col-md-3 col-6 mb-3">
                        <div class="border rounded p-3">
                            <i class="fas fa-layer-group text-info mb-2" style="font-size: 2rem;"></i>
                            <h4 class="mb-1" id="uniqueClasses">0</h4>
                            <small class="text-muted">Unique Classes</small>
                        </div>
                    </div>
                </div>
                
                <!-- Class Distribution -->
                <div class="mt-4" id="classDistribution" style="display: none;">
                    <h6><i class="fas fa-pie-chart me-2"></i>Class Distribution</h6>
                    <div id="classesList" class="mt-3">
                        <!-- Classes will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Export Options -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-file-export me-2"></i>
                    Export Formats
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-4">
                    Choose your preferred format for exporting the labeled dataset. Each format is optimized for different machine learning frameworks.
                </p>
                
                <div class="row">
                    {% for format in export_formats %}
                    <div class="col-md-4 mb-3">
                        <div class="card border-2 export-format-card" data-format="{{ format }}">
                            <div class="card-body text-center">
                                {% if format == 'yolo' %}
                                    <i class="fas fa-eye text-primary mb-3" style="font-size: 2.5rem;"></i>
                                    <h5>YOLO</h5>
                                    <p class="text-muted small">
                                        Perfect for YOLO object detection models. Includes normalized coordinates and class files.
                                    </p>
                                    <ul class="list-unstyled text-start small">
                                        <li><i class="fas fa-check text-success me-1"></i> labels/ folder with .txt files</li>
                                        <li><i class="fas fa-check text-success me-1"></i> images/ folder with images</li>
                                        <li><i class="fas fa-check text-success me-1"></i> classes.txt file</li>
                                    </ul>
                                {% elif format == 'coco' %}
                                    <i class="fas fa-database text-warning mb-3" style="font-size: 2.5rem;"></i>
                                    <h5>COCO</h5>
                                    <p class="text-muted small">
                                        Common Objects in Context format. JSON-based format used by many frameworks.
                                    </p>
                                    <ul class="list-unstyled text-start small">
                                        <li><i class="fas fa-check text-success me-1"></i> annotations.json file</li>
                                        <li><i class="fas fa-check text-success me-1"></i> Complete metadata</li>
                                        <li><i class="fas fa-check text-success me-1"></i> Category definitions</li>
                                    </ul>
                                {% elif format == 'pascal_voc' %}
                                    <i class="fas fa-file-code text-info mb-3" style="font-size: 2.5rem;"></i>
                                    <h5>Pascal VOC</h5>
                                    <p class="text-muted small">
                                        XML-based format. Compatible with many computer vision tools and frameworks.
                                    </p>
                                    <ul class="list-unstyled text-start small">
                                        <li><i class="fas fa-check text-success me-1"></i> Individual .xml files</li>
                                        <li><i class="fas fa-check text-success me-1"></i> Detailed annotations</li>
                                        <li><i class="fas fa-check text-success me-1"></i> Image metadata</li>
                                    </ul>
                                {% endif %}
                                
                                <button class="btn btn-outline-primary w-100 mt-3" onclick="exportDataset('{{ format }}')">
                                    <i class="fas fa-download me-1"></i>
                                    Export {{ format.upper() }}
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <div class="alert alert-info mt-4">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Note:</strong> Exports will only include frames that have been annotated. 
                    Make sure to complete your annotations before exporting the final dataset.
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Export Progress Modal -->
<div class="modal fade" id="exportModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center py-4">
                <div class="mb-3">
                    <i class="fas fa-file-export fa-spin text-success" style="font-size: 3rem;"></i>
                </div>
                <h5>Exporting Dataset...</h5>
                <p class="text-muted mb-3" id="exportStatus">Preparing export in <span id="exportFormat"></span> format</p>
                <div class="progress">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" style="width: 100%"></div>
                </div>
                <p class="text-muted mt-3 mb-0">This may take a few moments.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    loadProjectStats();
    formatCreatedDate();
    
    // Add hover effects to export cards
    $('.export-format-card').hover(
        function() { $(this).addClass('border-primary shadow-sm'); },
        function() { $(this).removeClass('border-primary shadow-sm'); }
    );
});

function loadProjectStats() {
    $.get('/api/project/{{ project_id }}/stats')
        .done(function(data) {
            // Update statistics
            $('#totalAnnotations').text(data.total_annotations);
            $('#uniqueClasses').text(data.unique_classes);
            
            // Update progress
            var progressPercent = Math.round(data.completion_percentage);
            $('#progressPercent').text(progressPercent + '%');
            $('#progressBar').css('width', progressPercent + '%');
            
            // Update progress bar color
            var progressBar = $('#progressBar');
            progressBar.removeClass('bg-danger bg-warning bg-success');
            if (progressPercent < 25) {
                progressBar.addClass('bg-danger');
            } else if (progressPercent < 75) {
                progressBar.addClass('bg-warning');
            } else {
                progressBar.addClass('bg-success');
            }
            
            // Show class distribution if we have classes
            if (data.classes && data.classes.length > 0) {
                $('#classDistribution').show();
                var classesList = $('#classesList');
                classesList.empty();
                
                data.classes.forEach(function(className) {
                    var badge = $('<span class="badge bg-secondary me-2 mb-2">' + className + '</span>');
                    classesList.append(badge);
                });
            }
        })
        .fail(function() {
            showToast('Failed to load project statistics', 'warning');
        });
}

function formatCreatedDate() {
    var dateStr = '{{ metadata.created_at }}';
    if (dateStr) {
        var date = new Date(dateStr);
        var formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        $('#createdDate').text(formattedDate);
    }
}

function exportDataset(format) {
    // Show export modal
    $('#exportFormat').text(format.toUpperCase());
    $('#exportModal').modal('show');
    
    // Create a temporary link to trigger download
    var link = document.createElement('a');
    link.href = '/api/export/{{ project_id }}/' + format;
    link.download = '{{ project_id }}_' + format + '_dataset.zip';
    
    // Handle download completion
    link.onload = function() {
        setTimeout(function() {
            $('#exportModal').modal('hide');
            showToast('Dataset exported successfully!', 'success');
        }, 2000);
    };
    
    // Handle download error
    link.onerror = function() {
        $('#exportModal').modal('hide');
        showToast('Export failed. Please try again.', 'danger');
    };
    
    // Trigger download
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    // Hide modal after a delay (fallback)
    setTimeout(function() {
        $('#exportModal').modal('hide');
        showToast('Download started! Check your downloads folder.', 'info');
    }, 3000);
}

// Add some visual feedback for export cards
$(document).on('click', '.export-format-card', function() {
    var format = $(this).data('format');
    $(this).addClass('border-success');
    setTimeout(function() {
        $('.export-format-card').removeClass('border-success');
    }, 1000);
});
</script>
{% endblock %} 